<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lux Scepter â€“ Home</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body {
  background:#0a0a0a;
  color:white;
  font-family: "Times New Roman", serif;
  padding:40px;
}
#feed video {
  width:400px;
  margin:20px 0;
  display:block;
}
input, button {
  display:block;
  margin:10px 0;
  padding:10px;
  width:300px;
  background:#111;
  color:white;
  border:1px solid #444;
}
button { cursor:pointer; }
</style>
</head>
<body>

<h1 style="font-family: Chomsky, serif;">Lux Scepter</h1>

<button id="logout">Sign Out</button>

<h2>Upload Video</h2>
<input id="file" type="file" accept="video/*">
<button id="upload_btn">Upload</button>

<h2>Feed</h2>
<div id="feed"></div>

<script>
const supabase = supabase.createClient(
  "https://uewvmldolwgihfkxwlsl.supabase.co",
  "YOUR_PUBLIC_SUPABASE_ANON_KEY"
);

async function checkAuth() {
  const { data } = await supabase.auth.getUser();
  if (!data.user) window.location = "index.html";
}
checkAuth();

document.getElementById("logout").onclick = async () => {
  await supabase.auth.signOut();
  window.location = "index.html";
};

document.getElementById("upload_btn").onclick = async () => {
  const file = document.getElementById("file").files[0];
  if (!file) return alert("Pick a file.");

  const form = new FormData();
  form.append("file", file);

  // Send video to your secure server endpoint
  const upload = await fetch("/upload", {
    method: "POST",
    body: form
  });

  if (!upload.ok) {
    alert("Upload failed.");
    return;
  }

  alert("Uploaded.");
  loadFeed();
};

async function loadFeed() {
  // FEED FROM PUBLIC R2 FOLDER
  const feed = document.getElementById("feed");
  feed.innerHTML = "";

  // Public R2 listing (JSON)
  const res = await fetch("https://pub-896ac4804d024c16a6eddd0fcc22782e.r2.dev/?format=json");
  if (!res.ok) return;
  const list = await res.json();

  list.objects.forEach(obj => {
    const url = `https://pub-896ac4804d024c16a6eddd0fcc22782e.r2.dev/${obj.key}`;
    if (url.endsWith(".mp4") || url.endsWith(".mov") || url.endsWith(".mkv")) {
      const vid = document.createElement("video");
      vid.src = url;
      vid.controls = true;
      feed.appendChild(vid);
    }
  });
}

loadFeed();
</script>

</body>
</html>
