<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lux Scepter â€” Feed</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Chomsky&display=swap');
  body {
    margin: 0;
    font-family: 'Times New Roman', serif;
    background: linear-gradient(to bottom, #0b0b0b, #1b0b2b);
    color: #f0d75b;
    overflow-x: hidden;
  }
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1em 2em;
    background: linear-gradient(90deg, #35005a, #5600a1);
    box-shadow: 0 0 20px rgba(240,215,91,0.5);
  }
  header h1 {
    font-family: 'Chomsky', sans-serif;
    font-size: 2.2em;
    color: #f0d75b;
  }
  header button {
    padding: 0.5em 1em;
    border: none;
    border-radius: 6px;
    background: #f0d75b;
    color: #0b0b0b;
    cursor: pointer;
    font-weight: bold;
  }
  #upload-section {
    margin: 2em;
    padding: 1.5em;
    border: 2px solid #5600a1;
    border-radius: 12px;
    background: #0e0e0e;
    box-shadow: 0 0 15px rgba(240,215,91,0.2);
  }
  #upload-section h2 {
    margin-top: 0;
  }
  input, select {
    width: 100%;
    padding: 0.6em;
    margin: 0.5em 0;
    border-radius: 6px;
    border: 1px solid #35005a;
    background: #0e0e0e;
    color: #f0d75b;
    font-size: 1em;
  }
  button.upload-btn {
    background: #5600a1;
    color: #fff;
    font-weight: bold;
    margin-top: 1em;
    padding: 0.7em;
    width: 100%;
    font-size: 1.1em;
    cursor: pointer;
  }
  button.upload-btn:hover {
    background: #35005a;
  }
  #feed {
    display: flex;
    flex-direction: column;
    padding: 2em;
    gap: 2em;
  }
  .feed-item {
    background: #0e0e0e;
    border: 2px solid #571728;
    border-radius: 12px;
    padding: 1em;
    box-shadow: 0 0 10px rgba(240,215,91,0.3);
  }
  .feed-item video {
    width: 100%;
    border-radius: 8px;
    margin-top: 0.5em;
  }
  .feed-item .username {
    font-weight: bold;
    margin-bottom: 0.3em;
    color: #bd8e20;
  }
</style>
</head>
<body>
<header>
  <h1>Lux Scepter</h1>
  <button id="logout">Logout</button>
</header>

<section id="upload-section">
  <h2>Upload Video</h2>
  <input type="file" id="video-input" accept="video/*">
  <button class="upload-btn" id="upload-btn">Upload to Realm</button>
  <div id="status" style="margin-top:1em;color:#f0d75b;"></div>
</section>

<section id="feed">
  <h2>Realm Feed</h2>
</section>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabaseUrl = 'https://uewvmldolwgihfkxwlsl.supabase.co'
const supabaseKey = 'YOUR_SUPABASE_ANON_KEY' // replace
const supabase = createClient(supabaseUrl, supabaseKey)

// Check user auth
async function checkAuth() {
  const user = supabase.auth.user()
  if (!user) window.location.href = 'index.html'
  else {
    loadFeed()
  }
}
checkAuth()

// Logout
document.getElementById('logout').addEventListener('click', async () => {
  await supabase.auth.signOut()
  window.location.href = 'index.html'
})

// Upload Video
document.getElementById('upload-btn').addEventListener('click', async () => {
  const fileInput = document.getElementById('video-input')
  const file = fileInput.files[0]
  if (!file) return alert('Select a video file')

  const user = supabase.auth.user()

  // Verify creator
  const { data: profile } = await supabase
    .from('profiles')
    .select('is_creator, username')
    .eq('id', user.id)
    .single()

  if (!profile.is_creator) return alert('You need an invite code to upload')

  const statusEl = document.getElementById('status')
  statusEl.textContent = 'Uploading...'

  try {
    // Upload to Cloudflare R2
    const res = await fetch(`https://YOUR_CLOUDFLARE_BUCKET.r2.dev/${file.name}`, {
      method: 'PUT',
      body: file
    })
    if (!res.ok) throw new Error('Upload failed')

    const videoUrl = `https://YOUR_CLOUDFLARE_BUCKET.r2.dev/${file.name}`

    // Save to Supabase feed
    await supabase.from('feed').insert([{
      user_id: user.id,
      username: profile.username,
      url: videoUrl,
      created_at: new Date()
    }])

    statusEl.textContent = 'Upload successful!'
    fileInput.value = ''
    loadFeed()
  } catch (err) {
    statusEl.textContent = 'Upload failed: ' + err.message
  }
})

// Load feed
async function loadFeed() {
  const { data: videos } = await supabase
    .from('feed')
    .select('*')
    .order('created_at', { ascending: false })

  const feedEl = document.getElementById('feed')
  feedEl.innerHTML = '<h2>Realm Feed</h2>'

  videos.forEach(v => {
    const div = document.createElement('div')
    div.className = 'feed-item'
    div.innerHTML = `
      <div class="username">@${v.username}</div>
      <video src="${v.url}" controls></video>
    `
    feedEl.appendChild(div)
  })
}
</script>
</body>
</html>
