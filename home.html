<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Lux Scepter â€” Realm</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- BRAND COLORS -->
<style>
:root {
  --black:#0e0e0e;
  --wine:#571728;
  --violet:#35005a;
  --purple:#5600a1;
  --gold:#bd8e20;
}

body {
  margin:0;
  padding:0;
  background:var(--black);
  font-family: "Times New Roman", serif;
  color:white;
}

header {
  background:var(--violet);
  padding:15px;
  text-align:center;
  font-size:28px;
  color:var(--gold);
  font-weight:bold;
}

#uploader, #feed {
  margin:20px auto;
  width:92%;
  max-width:900px;
}

button {
  background:var(--purple);
  color:white;
  border:none;
  padding:12px 20px;
  cursor:pointer;
  font-size:16px;
}

button:hover {
  background:var(--wine);
}

.post {
  background:#111;
  border:1px solid var(--violet);
  padding:15px;
  margin-bottom:25px;
  border-radius:6px;
}

video {
  width:100%;
  border:1px solid var(--gold);
  background:black;
}

.locked {
  text-align:center;
  margin-top:100px;
  font-size:22px;
  color:var(--gold);
}
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<header>Realm Feed</header>

<div id="content"></div>

<script>
// ===================================
// CONFIG
// ===================================
const SUPABASE_URL = "https://uewvmldolwgihfkxwlsl.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVld3ZtbGRvbHdnaWhma3h3bHNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MzQ1MjksImV4cCI6MjA3OTUxMDUyOX0.b9C00OjIkAUDPztC8RtdHcwjdgX4OrShNW_pp6r-_qI";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// Cloudflare R2 S3 Endpoint
const R2_BUCKET = "luxscepter-uploads";
const R2_BASE = "https://4aefdc871e931f0ca228941ee1599c02.r2.cloudflarestorage.com";
const R2_PUBLIC = "https://pub-896ac4804d024c16a6eddd0fcc22782e.r2.dev";
const R2_KEY_ID = "e99af04b068a9a23ce46845e3ecf8efa";
const R2_SECRET = "154bf5eaf1516e58c9055f8df68bd80640b848d498872b23e1eab43589559f4f";

// ===================================
// SESSION CHECK
// ===================================
let CURRENT_USER = null;

async function init() {
  const { data: { session } } = await supabase.auth.getSession();

  if (!session) {
    document.getElementById("content").innerHTML =
      `<div class="locked">You must sign in on index.html before entering the Realm.</div>`;
    return;
  }

  CURRENT_USER = session.user;

  renderUI();
  loadFeed();
}

init();

// ===================================
// UI TEMPLATE
// ===================================
function renderUI() {
  document.getElementById("content").innerHTML = `
    <div id="uploader">
      <h2 style="color:var(--gold)">Upload to Realm</h2>
      <input type="file" id="fileInput" accept="video/*" style="color:white;"><br><br>
      <button onclick="uploadVideo()">Upload</button>
      <div id="uploadStatus" style="margin-top:10px;color:var(--gold)"></div>
    </div>

    <h2 style="color:var(--gold);margin-left:4%;">Feed</h2>
    <div id="feed"></div>
  `;
}

// ===================================
// CLOUDLFARE R2 UPLOAD
// ===================================
async function uploadVideo() {
  const file = document.getElementById("fileInput").files[0];
  if (!file) return alert("Choose a file.");

  const uploadName = `${CURRENT_USER.id}_${Date.now()}_${file.name}`;
  const uploadURL = `${R2_BASE}/${R2_BUCKET}/${uploadName}`;

  document.getElementById("uploadStatus").innerText = "Uploading to R2...";

  // Core S3-style upload
  const res = await fetch(uploadURL, {
    method: "PUT",
    headers: {
      "Content-Type": file.type,
      "x-amz-meta-uploader": CURRENT_USER.id,
      "Authorization": "Basic " + btoa(`${R2_KEY_ID}:${R2_SECRET}`)
    },
    body: file
  });

  if (!res.ok) {
    document.getElementById("uploadStatus").innerText = "Upload failed.";
    return;
  }

  const publicURL = `${R2_PUBLIC}/${uploadName}`;
  document.getElementById("uploadStatus").innerText = "Uploaded. Saving post...";

  // ===================================
  // SAVE POST IN SUPABASE
  // ===================================
  const { error } = await supabase
    .from("posts")
    .insert({
      user_id: CURRENT_USER.id,
      video_url: publicURL,
      created_at: new Date().toISOString()
    });

  if (error) {
    document.getElementById("uploadStatus").innerText = "Post save failed.";
    return;
  }

  document.getElementById("uploadStatus").innerText = "Posted to Realm.";
  loadFeed();
}

// ===================================
// FEED LOAD
// ===================================
async function loadFeed() {
  const feed = document.getElementById("feed");
  feed.innerHTML = "Loading feed...";

  let { data, error } = await supabase
    .from("posts")
    .select("id, video_url, created_at, user_id")
    .order("created_at", { ascending: false });

  if (error) {
    feed.innerHTML = "Feed error.";
    return;
  }

  feed.innerHTML = "";

  for (const post of data) {
    const username = await fetchUsername(post.user_id);

    feed.innerHTML += `
      <div class="post">
        <div style="color:var(--gold);font-size:18px;margin-bottom:5px;">
          @${username}
        </div>
        <video src="${post.video_url}" controls></video>
      </div>
    `;
  }
}

// ===================================
// USERNAME FETCHER
// ===================================
async function fetchUsername(id) {
  const { data } = await supabase
    .from("profiles")
    .select("username")
    .eq("id", id)
    .maybeSingle();

  return data?.username || "unknown";
}
</script>
</body>
</html>
