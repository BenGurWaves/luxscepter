<!doctype html>
<html lang="en">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Upload â€” Founders Crown</title><link rel="stylesheet" href="style.css"></head>
<body>
<div class="container" style="max-width:760px">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div style="font-family:var(--brand-font);font-size:20px">Upload</div>
    <div><a class="link small" href="feed.html">Back to feed</a></div>
  </div>

  <form id="uploadForm" style="margin-top:22px;display:grid;gap:12px">
    <label class="small">Type</label>
    <select id="kind" required style="padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--white)">
      <option value="reign">Reign (vertical)</option>
      <option value="empire">Empire (horizontal)</option>
      <option value="throne">Throne (long-form)</option>
      <option value="decree">Decree (24h story)</option>
    </select>

    <input id="title" placeholder="Title (optional)" style="padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--white)"/>
    <textarea id="description" placeholder="Description" rows="4" style="padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--white)"></textarea>

    <label class="small">Select media file</label>
    <input id="file" type="file" accept="video/*,audio/*,image/*" />

    <div style="display:flex;gap:10px">
      <button class="btn" id="uploadBtn" type="button">Upload & Publish</button>
      <button class="btn secondary" id="saveDraft" type="button">Save Draft</button>
    </div>

    <div id="result" class="small" style="color:var(--tan)"></div>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script>
const SUPABASE_URL = 'https://YOUR-PROJECT.supabase.co';
const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY';
const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

async function uploadHandler(publish=false) {
  const file = document.getElementById('file').files[0];
  const kind = document.getElementById('kind').value;
  const title = document.getElementById('title').value;
  const description = document.getElementById('description').value;
  const user = (await supabase.auth.getUser()).data?.user;
  if (!user) return alert('Please sign in.');

  if (!file) return alert('Pick a file first.');

  const slug = `${user.id}/${Date.now()}_${file.name.replace(/\s/g,'_')}`;
  const bucket = 'media-video'; // ensure bucket exists
  try {
    // upload file
    const up = await supabase.storage.from(bucket).upload(slug, file, { cacheControl:'3600', upsert:false });
    if (up.error) throw up.error;
    const storagePath = up.data.path;

    // create content row
    const { data: content, error: cErr } = await supabase.from('contents').insert({
      author: user.id,
      kind,
      title,
      description,
      is_draft: !publish,
      published_at: publish ? new Date().toISOString() : null
    }).select().single();
    if (cErr) throw cErr;

    // attach media row
    await supabase.from('media').insert({
      content_id: content.id,
      storage_path: storagePath,
      mime: file.type,
      size: file.size
    });

    document.getElementById('result').textContent = publish ? 'Uploaded and published.' : 'Saved as draft.';
    if (publish) window.location.href = 'feed.html';
  } catch (err) {
    console.error(err);
    document.getElementById('result').textContent = 'Upload failed: ' + (err.message || err);
  }
}

document.getElementById('uploadBtn').addEventListener('click', ()=>uploadHandler(true));
document.getElementById('saveDraft').addEventListener('click', ()=>uploadHandler(false));
</script>
</body>
</html>
