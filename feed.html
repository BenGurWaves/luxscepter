<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dominion — Lux Scepter</title>
<style>
:root{--black:#000;--gold:#FFD700;--purple:#8A2BE2;--white:#fff;--tan:#D8C8A6}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#010101,#000);color:var(--white);font-family:"Times New Roman", Times, serif}
.container{max-width:1100px;margin:0 auto;padding:36px}
.header{display:flex;align-items:center;gap:12px}
.logo{width:56px;height:56px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(135deg,var(--gold),var(--purple));color:#000;font-weight:800}
.btn{background:var(--gold);color:#000;border:0;padding:8px 10px;border-radius:10px;cursor:pointer}
.input{padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--white)}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:12px;border-radius:10px;margin-bottom:12px}
.small{font-size:13px;color:#bdbdbd}
.preview{width:160px;height:90px;background:linear-gradient(90deg,var(--purple),var(--gold));border-radius:8px}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="logo">♛</div>
    <div style="font-family:var(--brand-font);font-size:18px">Lux Scepter — Dominion</div>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button id="myChannel" class="small btn">My channel</button>
      <button id="signOut" class="small">Sign out</button>
    </div>
  </div>

  <div style="display:flex;justify-content:space-between;align-items:center;margin-top:18px">
    <div>
      <h2 style="margin:0;font-family:var(--brand-font)">Dominion</h2>
      <div class="small">Public feed — chrono or algorithmic</div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <select id="sort" class="input"><option value="published_at.desc">Chronological</option><option value="score.desc">Algorithmic</option></select>
      <input id="q" class="input" placeholder="Oracle Edge — search" style="width:300px"/>
    </div>
  </div>

  <div style="display:flex;gap:20px;margin-top:18px">
    <main style="flex:1">
      <div id="feed" style="margin-top:12px"></div>
    </main>

    <aside style="width:340px">
      <div class="card">
        <div class="small">Quick upload</div>
        <div style="margin-top:10px">
          <select id="kind" class="input"><option value="reign">Reign</option><option value="empire">Empire</option><option value="throne">Throne</option><option value="decree">Decree</option></select>
          <input id="title" class="input" placeholder="Title" style="margin-top:8px"/>
          <input id="file" type="file" accept="video/*,image/*,audio/*" style="margin-top:8px"/>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="publish" class="btn">Upload & Publish</button>
            <button id="draft" class="small">Save Draft</button>
          </div>
          <div id="upmsg" class="small" style="margin-top:8px;color:var(--tan)"></div>
        </div>
      </div>

      <div class="card small" style="margin-top:12px">
        Founder crowns: one-time purchase grants founder badge and priority. Scepters: limited daily by tier.
      </div>
    </aside>
  </div>
</div>

<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // Replace these with your project public values
  const SUPABASE_URL = 'https://uewvmldolwgihfkxwlsl.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVld3ZtbGRvbHdnaWhma3h3bHNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MzQ1MjksImV4cCI6MjA3OTUxMDUyOX0.b9C00OjIkAUDPztC8RtdHcwjdgX4OrShNW_pp6r-_qI';
  const BUCKET = 'luxscepter-uploads';

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const feedEl = document.getElementById('feed');
  const sort = document.getElementById('sort');
  const q = document.getElementById('q');
  const publish = document.getElementById('publish');
  const draft = document.getElementById('draft');
  const upmsg = document.getElementById('upmsg');

  document.getElementById('signOut').addEventListener('click', async ()=>{ await supabase.auth.signOut(); location.href='index.html'; });
  document.getElementById('myChannel').addEventListener('click', async ()=>{ const u = await supabase.auth.getUser(); if (!u.data.user) return location.href='index.html'; location.href = `channel.html?u=${u.data.user.id}`; });

  async function loadFeed(){
    feedEl.innerHTML = '<div class="small">Loading…</div>';
    const s = sort.value.split('.');
    const col = s[0], desc = s[1] === 'desc';
    try {
      const { data, error } = await supabase.from('contents').select('id, title, kind, published_at, author, profiles:author(username, avatar_url)').is('is_draft', false).order(col, { ascending: !desc }).limit(50);
      if (error) throw error;
      if (!data || data.length === 0) { feedEl.innerHTML = '<div class="small">No public content yet.</div>'; return; }
      feedEl.innerHTML = data.map(item => {
        const time = item.published_at ? new Date(item.published_at).toLocaleString() : 'draft';
        const user = item.profiles?.username || 'anonymous';
        const avatar = item.profiles?.avatar_url ? supabase.storage.from(BUCKET).getPublicUrl(item.profiles.avatar_url).publicURL : null;
        return `
          <div class="card" style="display:flex;gap:12px;align-items:flex-start">
            <div class="preview"></div>
            <div style="flex:1">
              <div style="display:flex;justify-content:space-between"><div><strong style="color:var(--gold)">${(item.kind||'').toUpperCase()}</strong> · <span class="small">${user}</span></div><div class="small">${time}</div></div>
              <div style="margin-top:8px">${item.title || '(untitled)'}</div>
            </div>
          </div>`;
      }).join('');
    } catch (e) { console.error(e); feedEl.innerHTML = '<div class="small">Unable to load feed.</div>'; }
  }

  // Simple search (client-side ilike). For production use an RPC full-text search.
  q.addEventListener('keydown', (e)=> { if (e.key === 'Enter') doSearch(); });
  async function doSearch(){
    const term = q.value.trim();
    if (!term) return loadFeed();
    feedEl.innerHTML = '<div class="small">Searching…</div>';
    try {
      const { data } = await supabase.from('contents').select('id,title,kind,published_at,author,profiles:author(username)').ilike('title', `%${term}%`).is('is_draft', false).order('published_at', { ascending:false });
      feedEl.innerHTML = (data||[]).map(item => {
        const time = item.published_at ? new Date(item.published_at).toLocaleString() : 'draft';
        const user = item.profiles?.username || 'anonymous';
        return `
          <div class="card" style="display:flex;gap:12px;align-items:flex-start">
            <div class="preview"></div>
            <div style="flex:1">
              <div style="display:flex;justify-content:space-between"><div><strong style="color:var(--gold)">${(item.kind||'').toUpperCase()}</strong> · <span class="small">${user}</span></div><div class="small">${time}</div></div>
              <div style="margin-top:8px">${item.title || '(untitled)'}</div>
            </div>
          </div>`;
      }).join('') || '<div class="small">No results</div>';
    } catch (e) { console.error(e); feedEl.innerHTML = '<div class="small">Search failed.</div>'; }
  }

  // Upload handler
  publish.addEventListener('click', ()=> uploadHandler(true));
  draft.addEventListener('click', ()=> uploadHandler(false));

  async function uploadHandler(publish=false){
    upmsg.textContent = 'Preparing…';
    const file = document.getElementById('file').files[0];
    const kind = document.getElementById('kind').value;
    const title = document.getElementById('title').value.trim();
    if (!file) { upmsg.textContent = 'Pick a file.'; return; }
    const u = await supabase.auth.getUser();
    const user = u.data?.user;
    if (!user) { upmsg.textContent = 'Sign in required.'; return; }

    try {
      // Upload to storage
      const path = `media/${user.id}/${Date.now()}_${file.name.replace(/\s+/g,'_')}`;
      const { data: upData, error: upErr } = await supabase.storage.from(BUCKET).upload(path, file, { cacheControl:'3600', upsert:false });
      if (upErr) throw upErr;
      const storagePath = upData.path;

      // create content row
      const { data: content, error: cErr } = await supabase.from('contents').insert({
        author: user.id,
        kind,
        title: title || null,
        is_draft: !publish,
        published_at: publish ? new Date().toISOString() : null
      }).select().single();
      if (cErr) throw cErr;

      // link media
      const { error: mErr } = await supabase.from('media').insert({
        content_id: content.id,
        storage_path: storagePath,
        mime: file.type,
        size: file.size
      });
      if (mErr) throw mErr;

      upmsg.textContent = publish ? 'Published.' : 'Saved as draft.';
      setTimeout(()=> { document.getElementById('file').value = ''; document.getElementById('title').value = ''; loadFeed(); }, 700);
    } catch (err) {
      console.error(err); upmsg.textContent = 'Upload failed: ' + (err.message || err);
    }
  }

  // initial load
  loadFeed();
</script>
</body>
</html>
