<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dominion — Lux Scepter</title>
<style>
:root{
  --black:#000;
  --gold:#FFD700;
  --purple:#8A2BE2;
  --tan:#D8C8A6;
  --white:#fff;
  --brand-font: "Chomsky", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  --body-font: "Times New Roman", Times, serif;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#010101,#000);color:var(--white);font-family:var(--body-font)}
.container{max-width:1100px;margin:0 auto;padding:36px}
.header{display:flex;align-items:center;gap:18px}
.logo{width:56px;height:56px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(135deg,var(--gold),var(--purple));color:#000;font-weight:800;font-family:var(--brand-font);font-size:18px}
.brand{font-family:var(--brand-font);font-size:20px}
.controls{margin-left:auto;display:flex;gap:10px;align-items:center}
.small{font-size:13px;color:#bdbdbd}
.feed-row{display:flex;gap:20px;margin-top:24px}
.feed{flex:1}
.aside{width:320px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:12px;border-radius:10px;margin-bottom:12px}
h2{font-family:var(--brand-font);margin:0 0 8px}
.select{padding:8px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--white)}
.uploader{background:rgba(255,255,255,0.02);padding:12px;border-radius:10px;margin-top:12px}
.input{width:100%;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--white)}
.btn{background:var(--gold);color:#000;border:0;padding:10px 12px;border-radius:10px;cursor:pointer}
.preview-thumb{width:140px;height:80px;background:linear-gradient(90deg,var(--purple),var(--gold));border-radius:8px;flex-shrink:0}
.meta{color:#cfcfcf;font-size:13px}
.footer{margin-top:30px;color:#888}
.link{color:var(--gold);text-decoration:none}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="logo">♛</div>
    <div class="brand">Lux Scepter</div>
    <div class="controls">
      <button id="toChannel" class="small">My Channel</button>
      <button id="signOut" class="small">Sign out</button>
    </div>
  </div>

  <div style="display:flex;justify-content:space-between;align-items:center;margin-top:18px">
    <h2>Dominion</h2>
    <div style="display:flex;gap:12px;align-items:center">
      <select id="sortSelect" class="select">
        <option value="published_at.desc">Chronological</option>
        <option value="score.desc">Algorithmic</option>
      </select>
      <input id="search" class="input" placeholder="Oracle Edge — search" style="width:320px"/>
    </div>
  </div>

  <div class="feed-row">
    <main class="feed">
      <div id="feedList" style="margin-top:12px"></div>
      <div class="footer small">Public feed — content published by creators</div>
    </main>

    <aside class="aside">
      <div class="card">
        <div class="small">Quick Upload</div>
        <div class="uploader">
          <label class="small">Type</label>
          <select id="kind" class="input" style="margin-top:6px">
            <option value="reign">Reign (vertical)</option>
            <option value="empire">Empire (horizontal)</option>
            <option value="throne">Throne (long-form)</option>
            <option value="decree">Decree (24h story)</option>
          </select>
          <input id="title" class="input" placeholder="Title" style="margin-top:8px"/>
          <input id="file" type="file" accept="video/*,image/*,audio/*" style="margin-top:8px"/>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="publish" class="btn">Upload & Publish</button>
            <button id="draft" class="btn" style="background:transparent;color:var(--white);border:1px solid rgba(255,255,255,0.06)">Save Draft</button>
          </div>
          <div id="upmsg" class="small" style="margin-top:8px;color:var(--tan)"></div>
        </div>
      </div>

      <div class="card">
        <div class="small">About</div>
        <div class="meta" style="margin-top:6px">Unlimited Crowns, daily Scepters per tier, founder priority. Uploads appear here after publish.</div>
      </div>
    </aside>
  </div>
</div>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<script>
const SUPABASE_URL = 'https://YOUR-PROJECT.supabase.co';
const SUPABASE_ANON_KEY = 'YOUR_ANON_KEY';
const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const feedList = document.getElementById('feedList');
const sortSelect = document.getElementById('sortSelect');
const searchInput = document.getElementById('search');
const publishBtn = document.getElementById('publish');
const draftBtn = document.getElementById('draft');
const upmsg = document.getElementById('upmsg');

document.getElementById('signOut').addEventListener('click', async ()=> {
  await supabase.auth.signOut();
  location.href = 'index.html';
});

document.getElementById('toChannel').addEventListener('click', async ()=>{
  const u = await supabase.auth.getUser();
  const id = u.data?.user?.id;
  if (!id) return location.href = 'index.html';
  location.href = 'channel.html?u=' + id;
});

async function loadFeed() {
  feedList.innerHTML = '<div class="small">Loading…</div>';
  try {
    const sort = sortSelect.value.split('.');
    const col = sort[0];
    const dir = sort[1] === 'asc';
    const { data, error } = await supabase.from('contents').select('id, title, kind, published_at, author, profiles:author(username, avatar_url)').is('is_draft', false).order(col, { ascending: !dir });
    if (error) throw error;
    if (!data || data.length === 0) { feedList.innerHTML = '<div class="small">No public content yet.</div>'; return; }
    feedList.innerHTML = data.map(item => renderCard(item)).join('');
  } catch (e) {
    console.error(e);
    feedList.innerHTML = '<div class="small">Feed load error.</div>';
  }
}

function renderCard(item) {
  const time = item.published_at ? new Date(item.published_at).toLocaleString() : 'draft';
  const user = item.profiles?.username || 'anonymous';
  const avatar = item.profiles?.avatar_url ? supabase.storage.from('avatars').getPublicUrl(item.profiles.avatar_url).publicURL : null;
  return `
    <div class="card" style="display:flex;gap:12px;align-items:flex-start">
      <div class="preview-thumb"></div>
      <div style="flex:1">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong style="color:var(--gold)">${(item.kind||'').toUpperCase()}</strong> · <span class="small">${user}</span></div>
          <div class="small">${time}</div>
        </div>
        <div style="margin-top:8px;font-size:16px">${item.title || 'Untitled'}</div>
      </div>
    </div>
  `;
}

sortSelect.addEventListener('change', loadFeed);

// Search: simple ilike on title (RPC recommended in production)
document.getElementById('search').addEventListener('keydown', (e) => { if (e.key === 'Enter') doSearch(); });
async function doSearch(){
  const q = searchInput.value.trim();
  if (!q) return loadFeed();
  feedList.innerHTML = '<div class="small">Searching…</div>';
  try {
    const { data } = await supabase.from('contents').select('id, title, kind, published_at, author, profiles:author(username, avatar_url)').ilike('title', `%${q}%`).is('is_draft', false).order('published_at', { ascending: false });
    feedList.innerHTML = (data || []).map(renderCard).join('') || '<div class="small">No results</div>';
  } catch (e) { console.error(e); feedList.innerHTML = '<div class="small">Search failed</div>'; }
}

// Upload flow
publishBtn.addEventListener('click', ()=> uploadHandler(true));
draftBtn.addEventListener('click', ()=> uploadHandler(false));

async function uploadHandler(publish=false){
  upmsg.textContent = 'Preparing upload…';
  const kind = document.getElementById('kind').value;
  const title = document.getElementById('title').value.trim();
  const f = document.getElementById('file').files[0];
  if (!f) { upmsg.textContent = 'Pick a file.'; return; }

  const userObj = await supabase.auth.getUser();
  const user = userObj.data?.user;
  if (!user) { upmsg.textContent = 'Sign in required.'; return; }

  try {
    // upload to storage
    const slug = `media-video/${user.id}/${Date.now()}_${f.name.replace(/\s/g,'_')}`;
    const up = await supabase.storage.from('media-video').upload(slug, f, { cacheControl:'3600', upsert:false });
    if (up.error) throw up.error;
    const storagePath = up.data.path;

    // insert content row and media row
    const { data: content, error: cErr } = await supabase.from('contents').insert({
      author: user.id,
      kind,
      title,
      is_draft: !publish,
      published_at: publish ? new Date().toISOString() : null
    }).select().single();
    if (cErr) throw cErr;

    const { error: mErr } = await supabase.from('media').insert({
      content_id: content.id,
      storage_path: storagePath,
      mime: f.type,
      size: f.size
    });
    if (mErr) throw mErr;

    upmsg.textContent = publish ? 'Published.' : 'Saved as draft.';
    setTimeout(()=> { document.getElementById('title').value=''; document.getElementById('file').value=''; loadFeed(); }, 900);
  } catch (err) {
    console.error(err); upmsg.textContent = 'Upload failed: ' + (err.message || err);
  }
}

loadFeed();
</script>
</body> 
</html>
