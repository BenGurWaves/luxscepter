<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Realm — Lux Scepter (Feed)</title>
<style>
  /* Royal minimal — black / gold / indigo / red */
  :root{
    --black:#000000;
    --gold:#D4AF37;
    --indigo:#4B0082;
    --red:#8B0000;
    --muted:#1a1a1a;
  }
  html,body{height:100%;margin:0;background:var(--black);color:#eee;font-family: "Chomsky","Times New Roman",serif;}
  .wrap{max-width:1100px;margin:28px auto;padding:24px;}
  header{display:flex;align-items:center;gap:18px;margin-bottom:26px}
  h1{font-size:28px;margin:0;color:var(--gold);letter-spacing:0.06em}
  .sub{color:#cfcfcf;font-size:13px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-left:4px solid var(--gold);padding:16px;border-radius:8px;margin-bottom:12px}
  .title{font-size:18px;margin:0 0 6px 0;color:#fff}
  .meta{font-size:13px;color:#cfcfcf;display:flex;gap:12px;align-items:center}
  .thumb{width:220px;height:124px;background:#111;border-radius:6px;display:flex;align-items:center;justify-content:center;overflow:hidden}
  .row{display:flex;gap:18px}
  .actions{margin-left:auto}
  .btn{background:transparent;border:1px solid var(--gold);color:var(--gold);padding:8px 12px;border-radius:6px;cursor:pointer}
  .small{font-size:12px;color:#bbb}
  a.logo{color:var(--gold);text-decoration:none;font-weight:700}
  .empty{color:#999;padding:40px;text-align:center}
  footer{border-top:1px solid rgba(255,255,255,0.03);padding-top:12px;margin-top:18px;color:#999;font-size:12px}
  .tag{background:rgba(212,175,55,0.09);padding:6px;border-radius:6px;color:var(--gold);font-weight:600}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1><a class="logo" href="/">Lux Scepter — Realm</a></h1>
        <div class="sub">Rule the feed. Own the crown.</div>
      </div>
      <div style="margin-left:auto">
        <button class="btn" onclick="location.href='upload.html'">Upload Edict / Dominion</button>
      </div>
    </header>

    <main id="feed">
      <div class="empty">Loading feed…</div>
    </main>

    <footer>
      <span class="tag">♔ Crown</span> &nbsp; • &nbsp; Founding Bloodline preview • Static demo build
    </footer>
  </div>

<script>
/*
  INDEX.HTML
  - Lists contents from Supabase table `contents`.
  - Uses Supabase REST endpoint with the anon key you provided.
  - Sorting: newest published_at first, then created_at.
*/

const SUPabase = {
  url: 'https://uewvmldolwgihfkxwlsl.supabase.co',
  anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVld3ZtbGRvbHdnaWhma3h3bHNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MzQ1MjksImV4cCI6MjA3OTUxMDUyOX0.b9C00OjIkAUDPztC8RtdHcwjdgX4OrShNW_pp6r-_qI'
};

async function fetchFeed() {
  const q = '/rest/v1/contents?select=*,author:author(username,avatar)&order=coalesce(published_at,created_at.desc)&limit=50';
  // Note: If row-level security exists, anon key may be limited.
  try {
    const res = await fetch(SUPabase.url + q, {
      headers: {
        apikey: SUPabase.anonKey,
        Authorization: 'Bearer ' + SUPabase.anonKey
      }
    });
    if(!res.ok) throw new Error('Supabase responded ' + res.status);
    const items = await res.json();
    renderFeed(items);
  } catch (err) {
    console.error(err);
    document.getElementById('feed').innerHTML = `<div class="empty">Failed to load feed — check console for details.</div>`;
  }
}

function thumbnailFor(item){
  // If item.kind includes 'throne' or 'dominion' we can derive a thumbnail from R2 path or placeholder.
  // Use first 220px placeholder for now.
  return `<div class="thumb"><div style="padding:10px;text-align:center"><div style="font-size:13px;color:#bbb">${(item.kind||'content').toUpperCase()}</div><div style="margin-top:6px;font-size:12px;color:#888">${(item.duration_seconds||0) ? (Math.floor(item.duration_seconds/60)+':' + String(item.duration_seconds%60).padStart(2,'0')) : ''}</div></div></div>`;
}

function renderFeed(items){
  const root = document.getElementById('feed');
  if(!items || items.length===0){
    root.innerHTML = `<div class="empty">No contents yet. Go upload a Crown.</div>`;
    return;
  }
  root.innerHTML = '';
  items.forEach(it=>{
    const html = document.createElement('div');
    html.className = 'card';
    html.innerHTML = `
      <div class="row">
        ${thumbnailFor(it)}
        <div style="flex:1">
          <h3 class="title">${escapeHtml(it.title || '(Untitled)')}</h3>
          <div class="meta">
            <div class="small">By <strong>${escapeHtml((it.author && it.author.username) || 'unknown')}</strong></div>
            <div class="small">• ${escapeHtml(it.kind || 'edict')}</div>
            <div class="small">• ${it.published_at ? new Date(it.published_at).toLocaleString() : 'draft'}</div>
            <div class="actions">
              <button class="btn" onclick="openViewer('${encodeURIComponent(it.id)}')">Play</button>
            </div>
          </div>
          <p class="small" style="margin-top:10px;color:#d7d7d7">${escapeHtml(it.description || '')}</p>
        </div>
      </div>
    `;
    root.appendChild(html);
  });
}

function openViewer(id){
  // open watch page with id parameter
  location.href = 'watch.html?id=' + id;
}

function escapeHtml(s){
  if(!s) return '';
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

fetchFeed();
</script>
</body>
</html>
