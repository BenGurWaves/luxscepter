<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lux Scepter — Realm (Index) — Fixed</title>
<style>
  :root{
    --bg:#05060b; --gold:#D4AF37; --royal-blue:#0B3D91; --burgundy:#800020; --text:#eaeaea;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#02030a);color:var(--text);font-family:"Chomsky","Times New Roman",serif}
  .wrap{max-width:1200px;margin:28px auto;padding:22px}
  header{display:flex;align-items:center;gap:18px;margin-bottom:18px}
  h1{margin:0;color:var(--gold);font-size:28px}
  nav{margin-left:auto}
  .card{background:#0b0b0f;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03)}
  .btn{background:transparent;border:1px solid rgba(212,175,55,0.12);color:var(--gold);padding:8px 12px;border-radius:8px;cursor:pointer}
  .btn.alt{border-color:rgba(11,61,145,0.12);color:var(--royal-blue)}
  .btn.warn{border-color:rgba(128,0,32,0.12);color:var(--burgundy)}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
  input,textarea,select{width:100%;padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:var(--text)}
  .thumb{width:140px;height:80px;background:#070708;border-radius:6px;display:flex;align-items:center;justify-content:center;color:#aaa}
  .muted{color:#9a9a9a;font-size:13px}
  .small{font-size:13px;color:#cfcfcf}
  .feed-item{display:flex;gap:12px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);margin-bottom:10px}
  .uploadBox{border:1px dashed rgba(255,255,255,0.03);padding:10px;border-radius:8px}
  footer{margin-top:18px;color:#999;text-align:center;font-size:12px}
  @media(max-width:980px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Lux Scepter — Realm</h1>
        <div class="muted">Invite-only creators. Upload demos.</div>
      </div>
      <nav>
        <div id="authCard" class="card">
          <div id="signedOutControls">
            <div style="display:flex;gap:8px;">
              <input id="email" type="email" placeholder="email" style="width:200px" />
              <input id="password" type="password" placeholder="password" style="width:160px" />
            </div>
            <div style="display:flex;gap:8px;margin-top:8px;">
              <input id="inviteCode" placeholder="invite code (optional)" style="width:160px"/>
              <button id="btnSignUp" class="btn">Sign up</button>
              <button id="btnSignIn" class="btn alt">Sign in</button>
            </div>
            <div class="muted" style="margin-top:8px;font-size:12px">Use an invite code at sign-up to become a creator.</div>
          </div>

          <div id="signedInControls" style="display:none">
            <div style="display:flex;align-items:center;gap:8px;">
              <div class="small">Signed as <strong id="displayUsername">…</strong></div>
              <button id="btnUploadToggle" class="btn">Upload</button>
              <button id="btnSignOut" class="btn warn">Sign out</button>
            </div>
            <div id="creatorNote" class="muted" style="margin-top:6px;font-size:12px;display:none">You are a creator. Upload enabled.</div>
          </div>
        </div>
      </nav>
    </header>

    <div class="grid">
      <main>
        <div class="card" style="margin-bottom:12px;display:flex;justify-content:space-between;align-items:center">
          <div><strong>Search / Filters</strong><div class="muted">Search titles and descriptions</div></div>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="q" placeholder="search..." style="width:360px"/>
            <select id="filterKind" style="width:170px">
              <option value="">All</option>
              <option value="edict">Edict</option>
              <option value="dominion">Dominion</option>
              <option value="throne">Throne</option>
              <option value="song">Song</option>
              <option value="file">File</option>
            </select>
            <button id="btnSearch" class="btn">Search</button>
          </div>
        </div>

        <section class="card" id="feedCard">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong style="color:var(--gold)">Realm — Feed</strong></div>
            <div><label class="muted">Order</label>
              <select id="orderMode">
                <option value="chrono">Chrono</option>
                <option value="algo">Algo (demo)</option>
              </select>
            </div>
          </div>
          <div id="feedList" style="margin-top:12px"><div class="muted">Loading feed…</div></div>
        </section>

        <section class="card" id="songsCard" style="margin-top:12px">
          <div><strong style="color:var(--gold)">Songs</strong></div>
          <div id="songsList" style="margin-top:10px"><div class="muted">Loading songs…</div></div>
        </section>

        <section class="card" id="filesCard" style="margin-top:12px">
          <div><strong style="color:var(--gold)">Files — Downloads</strong></div>
          <div id="filesList" style="margin-top:10px"><div class="muted">Loading files…</div></div>
        </section>
      </main>

      <aside>
        <div id="uploadPanel" class="card" style="display:none">
          <div><strong style="color:var(--gold)">Upload (Creators)</strong></div>
          <div class="uploadBox" style="margin-top:8px">
            <label>Kind</label>
            <select id="upKind"><option value="edict">Edict</option><option value="dominion">Dominion</option><option value="throne">Throne</option><option value="song">Song</option><option value="file">File</option></select>
            <label style="margin-top:8px">Title</label>
            <input id="upTitle" placeholder="title"/>
            <label style="margin-top:8px">Description</label>
            <textarea id="upDesc" placeholder="description"></textarea>
            <label style="margin-top:8px">Choose file</label>
            <input id="upFile" type="file" accept="video/*,audio/*,application/*"/>
            <div style="display:flex;gap:8px;margin-top:10px">
              <button id="btnDoUpload" class="btn">Upload & Create</button>
              <button id="btnClearUpload" class="btn alt">Clear</button>
            </div>
            <div id="upStatus" class="muted" style="margin-top:8px">idle</div>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <div><strong style="color:var(--gold)">Founding Bloodline</strong></div>
          <div class="muted" style="margin-top:6px">Invite-only creators. Use a valid invite code at sign-up to become a creator.</div>
        </div>
      </aside>
    </div>

    <footer>Lux Scepter demo — Supabase + Cloudflare R2</footer>
  </div>

<script>
/* ---------- CONFIG (embedded keys, per your request) ---------- */
const SUPABASE = {
  url: 'https://uewvmldolwgihfkxwlsl.supabase.co',
  anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVld3ZtbGRvbHdnaWhma3h3bHNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MzQ1MjksImV4cCI6MjA3OTUxMDUyOX0.b9C00OjIkAUDPztC8RtdHcwjdgX4OrShNW_pp6r-_qI'
};

const R2 = {
  base: 'https://4aefdc871e931f0ca228941ee1599c02.r2.cloudflarestorage.com',
  bucketPath: '/luxscepter-uploads',
  accountId: '4aefdc871e931f0ca228941ee1599c02',
  accessKey: 'b1e60f0da846e830e9e77680cdf6eb3f',
  secretKey: '1a501b5c35f214508f03666242c8bf831373df226931670e7705e11966435dce'
};

/* ---------- Invite codes (normalized) ---------- */
const INVITE_CODES_RAW = ["NO81R","6AB1XF","8HK6B7","XCGM4K","P5PZQD","OQF3D4","J4537G","1XVGPK","29XJ84","71WW H","XJH6SO","93ZDYK","QGKT1D","DNV5XF","SB5Q07","4WEMY7","D6D30X","WYTJVN","SCY9KK","MXHJV2","SD32YC","TEKQOT","ALR9HA","8VSSRR","A1M8K6","W5SW9H","J3SMMY","9082GG","YNSYTW","G3MF6","9CGYH6","10K3YQ","MQC9FF","S2GHSY","DX3XT3","KXJ2B0","TD1DRJ","YG9Y3N","R1T8J7","KPHOBN","KVKBW5","45HKQK","6BA667","DAG645","BB6C17","FCE8X9","5XYVQg","H37E3N","DABHDS","HSDH5D","R17ZY6","2VXWKM","AXV91X","6NVCQ6","G8TQR1","D83MP1","5PYMOD","PR9YGA","T19BM2","TDH57W","BH48W6","7QBSYN","NAZD3W","8YKA7Z","MT3MMJ","NXVX1Q","TBRFTZ","0B8Z7G","F9K2DM","HVPZNF","PHQZ7Q","CPDQ17","NN75QV","80085331","MYHJE2","Z9HEBY","ZKLMN4","JPRQS7","TXHWD3","MNBVC8","QLRTS5","RZXCV1","HJGKL9","PWTYR2","VBCSD6","LXMPQO","KZHTY4","NE726V","7ZDCNP","B8D3TB","2J3MWH","CKRYDK","PHMM2K","C5R1Q3","DNA2BW","A85AN6","QDS6TD","FRVXHG","3ZVWDV","RK49W4","7KGZCK","RTR9MW","S717A4","RA1YOY","6PF355","SPWYYR","4AZPVT","EFX17C","WF2Q16","óFJKBM","DFEKG7","RVRKJS","H4WKA0","C8PDC8","9WSQSA","P8Y8JD","QGCSTD","2750B5","8HKZGG","MVM9FN","YQ6BVE","ERMYW7","2KXF80","2RJASG","8A6G7B","JQ5Q8R","2RAAYG","814KA5","91817K","GQ3JB3","087EA3","VK8F74","RHHRMY","C5XK4G","73RJ17","8XYNDN","BDHFSV","H43H3V","NGBFNF","TTEGG6","3EXK80","FGV2EQ","XEGJ6B","AVS3JC","BVJBX3","89VXBN","IDDQD","M02EGT","SK9H6P","PGZHV","C2Y15E","JGH5NC","TPV8C5","6Z6YG","ASAJW4","62K5MR","6S9T2B","7519GB","VKAGK6","H92713","Z3J7YW","TRJ49W","Q63FBK","KL138J","G81PQF","9T2Y3N","7M4P8T","3K9X2J","1 R6W5F","33M2FH","1 5YFX6","VNXQN"];
const INVITE_CODES = INVITE_CODES_RAW.map(c => String(c||'').toUpperCase().replace(/\s+/g,''));

/* ---------- Small DOM helpers ---------- */
function id(n){ return document.getElementById(n); }
function safe(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ---------- State ---------- */
let session = null; // { access_token, user }
let profile = null;

/* ---------- Auth functions ---------- */
async function signUp(email, password, inviteRaw){
  const code = String(inviteRaw||'').toUpperCase().replace(/\s+/g,'');
  try {
    const res = await fetch(`${SUPABASE.url}/auth/v1/signup`, {
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'apikey': SUPABASE.anonKey },
      body: JSON.stringify({ email, password })
    });
    const j = await res.json();
    if(!res.ok) throw new Error(JSON.stringify(j));
    // If session returned
    if(j && j.access_token && j.user){
      session = { access_token: j.access_token, user: j.user };
      localStorage.setItem('sup_session', JSON.stringify(session));
      await postSignIn(code);
    } else {
      alert('Sign-up ok. Confirm email if required; then sign in. If your provider auto-confirms you will be able to sign in immediately.');
    }
  } catch(err){
    console.error('signUp error', err);
    alert('Sign up failed: ' + (err.message||err));
  }
}

async function signIn(email, password){
  try {
    const form = new URLSearchParams();
    form.set('grant_type','password'); form.set('email',email); form.set('password',password);
    const res = await fetch(`${SUPABASE.url}/auth/v1/token`, {
      method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded', 'apikey': SUPABASE.anonKey }, body: form.toString()
    });
    const j = await res.json();
    if(!res.ok) throw new Error(JSON.stringify(j));
    session = { access_token: j.access_token, user: j.user };
    localStorage.setItem('sup_session', JSON.stringify(session));
    await postSignIn();
  } catch(err){
    console.error('signIn error', err);
    alert('Sign in failed: ' + (err.message||err));
  }
}

async function postSignIn(inviteNormalized){
  // set UI
  id('signedOutControls').style.display = 'none';
  id('signedInControls').style.display = '';
  id('displayUsername').innerText = session.user.email || '(user)';
  // ensure profile exists and patch creator flag if invite code valid
  try {
    const headers = { 'apikey': SUPABASE.anonKey, 'Authorization': 'Bearer ' + session.access_token };
    const r = await fetch(`${SUPABASE.url}/rest/v1/profiles?id=eq.${session.user.id}`, { headers });
    if(r.ok){
      const rows = await r.json();
      if(rows && rows.length > 0){
        profile = rows[0];
        if(profile.username) id('displayUsername').innerText = profile.username;
        // if inviteNormalized provided and valid and not already a creator -> patch
        if(inviteNormalized && INVITE_CODES.includes(inviteNormalized) && !profile.is_creator){
          await patchProfileCreator(inviteNormalized);
        }
      } else {
        // create profile
        const usernameDefault = session.user.email.split('@')[0];
        const payload = { id: session.user.id, username: usernameDefault, is_creator: (inviteNormalized && INVITE_CODES.includes(inviteNormalized)) ? true : false, creator_code_used: (inviteNormalized && INVITE_CODES.includes(inviteNormalized)) ? inviteNormalized : null };
        const c = await fetch(`${SUPABASE.url}/rest/v1/profiles`, { method:'POST', headers: {...headers, 'Content-Type':'application/json','Prefer':'return=representation'}, body: JSON.stringify(payload) });
        if(c.ok){ const created = await c.json(); profile = created[0] || null; if(profile && profile.username) id('displayUsername').innerText = profile.username; }
      }
    } else {
      console.warn('profile fetch failed', r.status);
    }
  } catch(e){
    console.warn('profile init failed', e);
  }
  // show upload if creator
  refreshUploadVisibility();
  loadEverything();
}

async function patchProfileCreator(code){
  try {
    const headers = { 'Content-Type':'application/json','apikey': SUPABASE.anonKey, 'Authorization': 'Bearer ' + session.access_token, 'Prefer':'return=representation' };
    const p = await fetch(`${SUPABASE.url}/rest/v1/profiles?id=eq.${session.user.id}`, { method:'PATCH', headers, body: JSON.stringify({ is_creator: true, creator_code_used: code }) });
    if(p.ok){ const rows = await p.json(); profile = rows[0] || profile; refreshUploadVisibility(); }
  } catch(e){ console.warn('patchCreator failed', e); }
}

/* restore session on page load */
(function restore(){
  const s = localStorage.getItem('sup_session');
  if(s){ try{ session = JSON.parse(s); if(session && session.user) postSignIn(); } catch(e){ localStorage.removeItem('sup_session'); } }
})();

/* ---------- DOM event wiring (fixed) ---------- */
id('btnSignUp').addEventListener('click', ()=> {
  const email = id('email').value.trim(), pw = id('password').value, code = id('inviteCode').value.trim();
  if(!email || !pw) return alert('Email + password required');
  signUp(email,pw,code);
});
id('btnSignIn').addEventListener('click', ()=> {
  const email = id('email').value.trim(), pw = id('password').value;
  if(!email || !pw) return alert('Email + password required');
  signIn(email,pw);
});
id('btnSignOut').addEventListener('click', ()=> {
  session = null; profile = null; localStorage.removeItem('sup_session');
  id('signedOutControls').style.display = ''; id('signedInControls').style.display = 'none'; id('uploadPanel').style.display = 'none'; id('displayUsername').innerText = '…';
});
id('btnUploadToggle').addEventListener('click', ()=> {
  if(id('uploadPanel').style.display === 'none' || id('uploadPanel').style.display === '') id('uploadPanel').style.display = ''; else id('uploadPanel').style.display = 'none';
});
id('btnSearch').addEventListener('click', ()=> loadEverything());
id('filterKind').addEventListener('change', ()=> loadEverything());
id('orderMode').addEventListener('change', ()=> loadEverything());
id('btnClearUpload').addEventListener('click', ()=> { id('upTitle').value=''; id('upDesc').value=''; id('upFile').value=''; id('upStatus').innerText='cleared'; });

/* ---------- Content loading ---------- */
async function loadEverything(){
  id('feedList').innerHTML = '<div class="muted">Loading feed…</div>';
  id('songsList').innerHTML = '<div class="muted">Loading songs…</div>';
  id('filesList').innerHTML = '<div class="muted">Loading files…</div>';

  const q = (id('q').value||'').trim();
  const kindFilter = id('filterKind').value || '';
  const order = id('orderMode').value || 'chrono';
  let filterParts = [];
  if(kindFilter) filterParts.push(`kind=eq.${encodeURIComponent(kindFilter)}`);
  if(q) filterParts.push(`or=(title.ilike.*${encodeURIComponent(q)}*,description.ilike.*${encodeURIComponent(q)}*)`);
  const filterQ = filterParts.length ? '&' + filterParts.join('&') : '';
  let url = `${SUPABASE.url}/rest/v1/contents?select=*,author:profiles(username)&limit=200${filterQ}`;
  if(order === 'chrono') url += '&order=coalesce(published_at,created_at).desc';

  try {
    const headers = {'apikey': SUPABASE.anonKey};
    if(session && session.access_token) headers['Authorization'] = 'Bearer ' + session.access_token;
    const res = await fetch(url, { headers });
    if(!res.ok) throw new Error('Supabase error ' + res.status);
    let rows = await res.json();
    if(order === 'algo') rows = shuffleArray(rows);
    renderFeed(rows);
    renderSongs(rows);
    renderFiles(rows);
  } catch(e){
    console.error('loadEverything',e);
    id('feedList').innerHTML = '<div class="muted">Failed to load feed — check console.</div>';
    id('songsList').innerHTML = '<div class="muted">Failed to load songs.</div>';
    id('filesList').innerHTML = '<div class="muted">Failed to load files.</div>';
  }
}

function renderFeed(items){
  if(!items || items.length===0){ id('feedList').innerHTML = '<div class="muted">No posts yet.</div>'; return; }
  const cont = document.createElement('div');
  items.forEach(it=>{
    if(it.kind === 'song' || it.kind === 'file') return;
    const box = document.createElement('div'); box.className='feed-item';
    const thumb = document.createElement('div'); thumb.className='thumb'; thumb.innerText = (it.kind||'CONTENT').toUpperCase();
    const meta = document.createElement('div'); meta.style.flex='1';
    meta.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${safe(it.title||'(Untitled)')}</strong><div class="muted">by ${safe(it.author && it.author.username || 'unknown')}</div></div><div class="muted">${it.published_at ? new Date(it.published_at).toLocaleString() : 'draft'}</div></div><div style="margin-top:8px" class="small">${safe((it.description||'').split('\\n').slice(0,3).join(' '))}</div>`;
    const actions = document.createElement('div'); actions.style.display='flex'; actions.style.flexDirection='column'; actions.style.gap='8px';
    const openBtn = document.createElement('button'); openBtn.className='btn'; openBtn.innerText='Open'; openBtn.onclick = ()=> openContent(it);
    actions.appendChild(openBtn);
    box.appendChild(thumb); box.appendChild(meta); box.appendChild(actions);
    cont.appendChild(box);
  });
  id('feedList').innerHTML=''; id('feedList').appendChild(cont);
}

function renderSongs(items){
  const songs = (items||[]).filter(i=>i.kind==='song');
  if(songs.length===0){ id('songsList').innerHTML = '<div class="muted">No songs yet.</div>'; return; }
  const wrap = document.createElement('div');
  songs.forEach(s=>{
    const r2 = extractR2Url(s.description) || extractExternalUrl(s.description);
    const row = document.createElement('div'); row.style.marginBottom='10px';
    row.innerHTML = `<div><strong>${safe(s.title||'(untitled)')}</strong> <div class="muted">by ${safe(s.author && s.author.username || 'unknown')}</div></div>`;
    if(r2){ const a = document.createElement('audio'); a.controls=true; a.src=r2; a.style.width='100%'; row.appendChild(a); } else { row.appendChild(Object.assign(document.createElement('div'),{className:'muted',innerText:'No audio URL'})); }
    wrap.appendChild(row);
  });
  id('songsList').innerHTML=''; id('songsList').appendChild(wrap);
}

function renderFiles(items){
  const files = (items||[]).filter(i=>i.kind==='file' || (i.description && /r2_url:/i.test(i.description)));
  if(files.length===0){ id('filesList').innerHTML = '<div class="muted">No files available for download.</div>'; return; }
  const wrap = document.createElement('div');
  files.forEach(f=>{
    const r2 = extractR2Url(f.description);
    const row = document.createElement('div'); row.className='fileLink'; row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.marginBottom='8px';
    row.innerHTML = `<div><strong>${safe(f.title||'(file)')}</strong><div class="muted">${safe((f.description||'').slice(0,120))}</div></div>`;
    const right = document.createElement('div');
    if(r2){ const a = document.createElement('a'); a.href=r2; a.download=''; a.className='btn alt'; a.innerText='Download'; right.appendChild(a); } else { right.appendChild(Object.assign(document.createElement('div'),{className:'muted',innerText:'No file URL'})); }
    row.appendChild(right); wrap.appendChild(row);
  });
  id('filesList').innerHTML=''; id('filesList').appendChild(wrap);
}

/* ---------- helpers ---------- */
function extractR2Url(description){
  if(!description) return null;
  const m = description.match(/r2_url:\s*(https?:\/\/\S+)/i) || description.match(/r2_url:(https?:\/\/\S+)/i);
  return m ? m[1] : null;
}
function extractExternalUrl(description){
  if(!description) return null;
  const m = description.match(/external_url:\s*(https?:\/\/\S+)/i) || description.match(/(https?:\/\/\S+)/i);
  return m ? m[1] : null;
}
function shuffleArray(a){ const arr = a.slice(); for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }
function openContent(it){ if(it.id) { window.location.href = 'watch.html?id=' + encodeURIComponent(it.id); } else alert('No ID'); }

/* ---------- Upload (client-side) ---------- */
function refreshUploadVisibility(){
  if(profile && profile.is_creator){
    id('uploadPanel').style.display = '';
    id('creatorNote').style.display = '';
  } else {
    id('uploadPanel').style.display = 'none';
    id('creatorNote').style.display = 'none';
  }
}

/* SigV4 (compact) */
async function sha256Hex(data){
  const buff = (data instanceof ArrayBuffer) ? data : new TextEncoder().encode(data);
  const hash = await crypto.subtle.digest('SHA-256', buff);
  return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,'0')).join('');
}
async function hmacBytes(keyBytes, msg){
  const cryptoKey = await crypto.subtle.importKey('raw', keyBytes, {name:'HMAC', hash:'SHA-256'}, false, ['sign']);
  const sig = await crypto.subtle.sign('HMAC', cryptoKey, new TextEncoder().encode(msg));
  return new Uint8Array(sig);
}
function toHex(u8){ return Array.from(u8).map(b=>b.toString(16).padStart(2,'0')).join(''); }
async function getSigningKey(secret, dateStamp, region, service){
  const kDate = await hmacBytes(new TextEncoder().encode('AWS4' + secret), dateStamp);
  const kRegion = await hmacBytes(kDate, region);
  const kService = await hmacBytes(kRegion, service);
  const kSigning = await hmacBytes(kService, 'aws4_request');
  return kSigning;
}
async function uploadToR2Signed(baseUrl, objectPath, file, accessKey, secretKey){
  const url = new URL(baseUrl);
  const host = url.host;
  const method = 'PUT';
  const service = 's3';
  const region = 'auto';
  const now = new Date();
  const amzDate = now.toISOString().replace(/[:-]|\.\d{3}/g,'') + 'Z';
  const dateStamp = amzDate.slice(0,8);
  const payloadArray = await file.arrayBuffer();
  const payloadHash = await sha256Hex(payloadArray);
  const canonicalUri = objectPath;
  const canonicalQueryString = '';
  const canonicalHeaders = `host:${host}\nx-amz-content-sha256:${payloadHash}\nx-amz-date:${amzDate}\n`;
  const signedHeaders = 'host;x-amz-content-sha256;x-amz-date';
  const canonicalRequest = [method, canonicalUri, canonicalQueryString, canonicalHeaders, signedHeaders, payloadHash].join('\n');
  const canonicalRequestHash = await sha256Hex(new TextEncoder().encode(canonicalRequest));
  const credentialScope = `${dateStamp}/${region}/${service}/aws4_request`;
  const stringToSign = ['AWS4-HMAC-SHA256', amzDate, credentialScope, canonicalRequestHash].join('\n');
  const signingKey = await getSigningKey(secretKey, dateStamp, region, service);
  const signature = toHex(await hmacBytes(signingKey, stringToSign));
  const authorization = `AWS4-HMAC-SHA256 Credential=${accessKey}/${credentialScope}, SignedHeaders=${signedHeaders}, Signature=${signature}`;
  const uploadUrl = baseUrl + canonicalUri;
  const resp = await fetch(uploadUrl, {
    method: 'PUT',
    headers: {
      'Content-Type': file.type || 'application/octet-stream',
      'x-amz-date': amzDate,
      'x-amz-content-sha256': payloadHash,
      'Authorization': authorization,
      'x-amz-acl': 'public-read'
    },
    body: file
  });
  return resp;
}

/* Upload handler */
id('btnDoUpload').addEventListener('click', async ()=>{
  if(!session || !session.user) return alert('Sign in first');
  if(!profile || !profile.is_creator) return alert('Only creators can upload');
  const file = id('upFile').files[0];
  if(!file) return alert('Choose a file');
  id('upStatus').innerText = 'Preparing...';
  const kind = id('upKind').value;
  const title = id('upTitle').value.trim() || '(untitled)';
  let desc = id('upDesc').value.trim() || '';
  const ts = Date.now();
  const safeName = file.name.replace(/[^a-zA-Z0-9.\-_]/g,'_');
  const key = `${kind}/${ts}_${Math.random().toString(36).slice(2,9)}_${safeName}`;
  const objectPath = `${R2.bucketPath}/${key}`;
  const objectUrl = `${R2.base}${objectPath}`;
  id('upStatus').innerText = 'Uploading to R2...';
  try {
    const resp = await uploadToR2Signed(R2.base, objectPath, file, R2.accessKey, R2.secretKey);
    if(!(resp && resp.status >=200 && resp.status <300)) throw new Error('Upload failed or CORS blocked. Resp: ' + (resp ? resp.status : 'no response'));
    id('upStatus').innerText = 'Upload OK. Saving metadata...';
    const payload = { author: session.user.id, kind, title, description: desc + '\n\nr2_url:' + objectUrl, duration_seconds: 0, is_draft: false, published_at: new Date().toISOString(), created_at: new Date().toISOString() };
    const hdrs = {'Content-Type':'application/json','apikey': SUPABASE.anonKey, 'Authorization': 'Bearer ' + session.access_token, 'Prefer':'return=representation'};
    const ins = await fetch(`${SUPABASE.url}/rest/v1/contents`, { method:'POST', headers: hdrs, body: JSON.stringify(payload) });
    if(!ins.ok){ const t = await ins.text(); throw new Error('Supabase insert failed: ' + ins.status + ' ' + t); }
    const created = await ins.json();
    id('upStatus').innerText = 'Saved content. Refreshing feed...';
    id('upTitle').value=''; id('upDesc').value=''; id('upFile').value='';
    loadEverything();
  } catch(e){
    console.error('upload error', e);
    id('upStatus').innerText = 'Upload error: ' + (e.message || e);
    alert('Upload failed: ' + (e.message || e));
  }
});

/* ---------- utilities ---------- */
function idExists(n){ return !!document.getElementById(n); }

/* ---------- initial load ---------- */
loadEverything();
refreshUploadVisibility();

/* ---------- console hints ---------- */
console.warn('This page contains embedded Supabase anon and R2 keys. Insecure for production.');
console.info('If sign-in fails with "Invalid API key", replace the anonKey with your project anon key from Supabase dashboard.');
console.info('If R2 upload fails with CORS, configure bucket CORS to allow your origin and methods GET, PUT, OPTIONS, HEAD');

/* ---------- helper function aliases used earlier ---------- */
function id(n){ return document.getElementById(n); }
</script>
</body>
</html>
