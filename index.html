<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Lux Scepter — Crown the moment</title>
<style>
:root{
  --black:#000;
  --gold:#FFD700;
  --purple:#8A2BE2;
  --tan:#D8C8A6;
  --white:#fff;
  --brand-font:"Chomsky", system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  --body-font:"Times New Roman", Times, serif;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#020202,#000);color:var(--white);font-family:var(--body-font)}
.container{max-width:1100px;margin:0 auto;padding:48px}
.header{display:flex;align-items:center;gap:18px}
.logo{width:64px;height:64px;border-radius:12px;display:grid;place-items:center;background:linear-gradient(135deg,var(--gold),var(--purple));color:#000;font-weight:800;font-family:var(--brand-font);font-size:20px}
.title{font-family:var(--brand-font);font-size:28px;margin:0}
.lead{color:#d0d0d0}
.btn{background:var(--gold);color:#000;border:0;padding:10px 14px;border-radius:10px;cursor:pointer}
.small-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:var(--white);cursor:pointer}
.input{width:100%;padding:10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--white)}
.sheet{background:#070707;padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);width:420px}
.modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,0.65)}
.modal.show{display:grid}
.muted{color:#bdbdbd;font-size:13px}
.note{color:var(--tan);font-size:13px;margin-top:10px}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="logo">♛</div>
    <div>
      <div class="title">Lux Scepter</div>
      <div class="muted">Crown the moment — founders alpha</div>
    </div>
    <div style="margin-left:auto">
      <button id="openAuth" class="small-btn">Sign in / Sign up</button>
      <a href="feed.html" style="color:var(--gold);margin-left:12px;text-decoration:none">Dominion</a>
    </div>
  </div>

  <section style="margin-top:40px;display:flex;gap:36px;align-items:flex-start">
    <div style="flex:1">
      <h1 style="font-family:var(--brand-font);font-size:44px;margin:0">Founders Crown — creators alpha</h1>
      <p class="lead">Invite-only creators, cinematic feed, founder priority, and a single lifetime Founding Crown purchase. Create your public Lux account and publish Reigns, Empires, Thrones.</p>
      <div style="display:flex;gap:12px;margin-top:18px">
        <button id="ctaCreate" class="btn">Create account</button>
        <a class="small-btn" href="feed.html">Explore public feed</a>
      </div>
      <div class="note">Security note: do not put service-role keys in client-side code. Use anon keys only.</div>
    </div>

    <aside style="width:360px">
      <div style="background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);padding:16px;border-radius:12px">
        <div style="font-weight:700;color:var(--gold)">Quick facts</div>
        <div class="muted" style="margin-top:10px">Unlimited Crowns, daily Scepters by tier, founder badges, and Oracle Edge search.</div>
      </div>
    </aside>
  </section>
</div>

<!-- modal dialog for auth & post-create -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="sheet" role="dialog" id="sheet">
    <!-- Step 1: signup -->
    <div id="step-signup">
      <h3 style="margin:0;font-family:var(--brand-font)">Create account</h3>
      <div class="muted" style="margin-top:8px">Email, username and password.</div>
      <div style="margin-top:12px">
        <input id="suEmail" class="input" type="email" placeholder="Email" />
      </div>
      <div style="margin-top:8px;display:flex;gap:8px">
        <input id="suUser" class="input" placeholder="Public username" />
        <input id="suPass" class="input" type="password" placeholder="Password" />
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="doSignup" class="btn">Create</button>
        <button id="gotoSignin" class="small-btn">Sign in</button>
      </div>
      <div id="suMsg" class="muted" style="margin-top:8px"></div>
    </div>

    <!-- Step 2: public profile + avatar upload -->
    <div id="step-public" style="display:none">
      <h3 style="margin:0;font-family:var(--brand-font)">Lux public account</h3>
      <div class="muted" style="margin-top:8px">Set display name, bio and avatar. This will appear on your channel and public feed.</div>
      <div style="margin-top:12px">
        <input id="pubDisplay" class="input" placeholder="Display name" />
      </div>
      <div style="margin-top:8px">
        <input id="pubBio" class="input" placeholder="Short bio" />
      </div>
      <div style="margin-top:8px">
        <label class="muted">Avatar (image)</label>
        <input id="pubAvatar" type="file" accept="image/*" style="margin-top:6px"/>
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="doPublic" class="btn">Create public profile</button>
        <button id="skipPublic" class="small-btn">Skip</button>
      </div>
      <div id="pubMsg" class="muted" style="margin-top:8px"></div>
    </div>

    <!-- Step: signin -->
    <div id="step-signin" style="display:none">
      <h3 style="margin:0;font-family:var(--brand-font)">Sign in</h3>
      <div class="muted" style="margin-top:8px">Email + password</div>
      <div style="margin-top:12px">
        <input id="siEmail" class="input" placeholder="Email" />
      </div>
      <div style="margin-top:8px">
        <input id="siPass" class="input" type="password" placeholder="Password" />
      </div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button id="doSignin" class="btn">Sign in</button>
        <button id="backToSignup" class="small-btn">Back</button>
      </div>
      <div id="siMsg" class="muted" style="margin-top:8px"></div>
    </div>
  </div>
</div>

<!-- Supabase ES module (avoids MIME/type blocking); +esm ensures proper module content-type -->
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // --- REPLACE THESE with your project's public values ---
  const SUPABASE_URL = 'https://uewvmldolwgihfkxwlsl.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVld3ZtbGRvbHdnaWhma3h3bHNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MzQ1MjksImV4cCI6MjA3OTUxMDUyOX0.b9C00OjIkAUDPztC8RtdHcwjdgX4OrShNW_pp6r-_qI';
  // -------------------------------------------------------

  if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
    console.error('Please set SUPABASE_URL and SUPABASE_ANON_KEY in the script.');
    // Allow page to still load visually; features will fail gracefully.
  }
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // UI wiring
  const modal = document.getElementById('modal');
  const sheet = document.getElementById('sheet');
  const openAuth = document.getElementById('openAuth');
  const ctaCreate = document.getElementById('ctaCreate');
  const stepSignup = document.getElementById('step-signup');
  const stepPublic = document.getElementById('step-public');
  const stepSignin = document.getElementById('step-signin');

  function show(step){
    modal.classList.add('show'); modal.removeAttribute('aria-hidden');
    stepSignup.style.display = step==='signup' ? 'block' : 'none';
    stepPublic.style.display = step==='public' ? 'block' : 'none';
    stepSignin.style.display = step==='signin' ? 'block' : 'none';
  }
  function hide(){ modal.classList.remove('show'); modal.setAttribute('aria-hidden','true'); }

  openAuth.onclick = () => show('signup');
  ctaCreate.onclick = () => show('signup');

  document.getElementById('gotoSignin').onclick = () => show('signin');
  document.getElementById('backToSignup').onclick = () => show('signup');
  document.getElementById('skipPublic').onclick = () => { hide(); window.location.href='feed.html'; };

  // SIGNUP: password flow
  document.getElementById('doSignup').addEventListener('click', async () => {
    const email = document.getElementById('suEmail').value.trim();
    const username = document.getElementById('suUser').value.trim();
    const password = document.getElementById('suPass').value;
    const suMsg = document.getElementById('suMsg'); suMsg.textContent = 'Creating account…';
    if (!email || !username || !password) { suMsg.textContent = 'Email, username, and password are required.'; return; }

    try {
      const { data, error } = await supabase.auth.signUp({ email, password });
      if (error) { suMsg.textContent = 'Sign up error: ' + error.message; return; }

      // If immediate user returned, create profile row.
      const user = data.user;
      if (user && user.id) {
        const { error: pErr } = await supabase.from('profiles').upsert({
          id: user.id,
          username,
          display_name: username,
          created_at: new Date().toISOString()
        }, { returning: 'minimal' }); // returning minimal avoids > payload
        if (pErr) { suMsg.textContent = 'Profile save error: ' + pErr.message; return; }
        suMsg.textContent = 'Account created. Fill public profile.';
        // show next step
        show('public');
      } else {
        // If your Supabase requires email confirmation before user object appears
        suMsg.textContent = 'Sign-up initiated. Confirm email, then sign in to continue.';
        // still show public creation step — note user might need to verify first depending on project settings
        show('public');
      }
    } catch (e) {
      console.error(e);
      suMsg.textContent = 'Unexpected error. See console.';
    }
  });

  // CREATE PUBLIC PROFILE + upload avatar to luxscepter-uploads
  document.getElementById('doPublic').addEventListener('click', async () => {
    const disp = document.getElementById('pubDisplay').value.trim();
    const bio = document.getElementById('pubBio').value.trim();
    const avatar = document.getElementById('pubAvatar').files[0];
    const pubMsg = document.getElementById('pubMsg'); pubMsg.textContent = 'Saving…';
    const userRes = await supabase.auth.getUser();
    const user = userRes.data?.user;
    if (!user) { pubMsg.textContent = 'You must be signed in to create public profile.'; return; }

    try {
      let avatar_path = null;
      if (avatar) {
        const fileName = `${user.id}/${Date.now()}_${avatar.name.replace(/\s+/g,'_')}`;
        const bucket = 'luxscepter-uploads';
        const up = await supabase.storage.from(bucket).upload(`avatars/${fileName}`, avatar, { cacheControl: '3600', upsert: false });
        if (up.error) throw up.error;
        avatar_path = up.data.path;
      }
      const upd = await supabase.from('profiles').update({
        display_name: disp || undefined,
        bio: bio || undefined,
        avatar_url: avatar_path || undefined
      }).eq('id', user.id);
      if (upd.error) { pubMsg.textContent = 'Save failed: ' + upd.error.message; return; }
      pubMsg.textContent = 'Public profile created. Redirecting to channel…';
      setTimeout(()=> { hide(); window.location.href = `channel.html?u=${user.id}`; }, 800);
    } catch (err) {
      console.error(err); pubMsg.textContent = 'Upload failed: ' + (err.message || err);
    }
  });

  // SIGNIN
  document.getElementById('doSignin').addEventListener('click', async () => {
    const email = document.getElementById('siEmail').value.trim();
    const password = document.getElementById('siPass').value;
    const siMsg = document.getElementById('siMsg'); siMsg.textContent = 'Signing in…';
    if (!email || !password) { siMsg.textContent = 'Email and password required.'; return; }
    try {
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) { siMsg.textContent = 'Sign-in error: ' + error.message; return; }
      siMsg.textContent = 'Signed in. Redirecting…';
      hide();
      window.location.href = `channel.html?u=${data.user.id}`;
    } catch (e) {
      console.error(e); siMsg.textContent = 'Unexpected error';
    }
  });

  // Close when clicking outside sheet
  document.getElementById('modal').addEventListener('click', (ev) => { if (ev.target.id === 'modal') hide(); });
</script>
</body>
</html>
