<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Throne — Watch</title>
<style>
  :root{--black:#000000;--gold:#D4AF37;--indigo:#4B0082;--red:#8B0000}
  html,body{height:100%;margin:0;background:var(--black);color:#eee;font-family:"Chomsky","Times New Roman",serif}
  .wrap{max-width:1100px;margin:28px auto;padding:20px}
  .title{color:var(--gold);font-size:22px;margin-bottom:6px}
  .meta{color:#cfcfcf;font-size:13px;margin-bottom:12px}
  .player{background:#070707;border-radius:8px;padding:10px;border:1px solid #222}
  video{width:100%;height:auto;border-radius:6px;background:#000}
  .back{margin-top:12px}
  .small{font-size:13px;color:#bbb}
</style>
</head>
<body>
  <div class="wrap">
    <div><a href="index.html" style="color:var(--gold);text-decoration:none">← Realm</a></div>
    <h1 id="title" class="title">Loading…</h1>
    <div id="meta" class="meta"></div>
    <div class="player" id="playerWrap">
      <div class="small">Loading player…</div>
    </div>
  </div>

<script>
/*
  WATCH.HTML
  - Reads ?id= content id
  - Fetches record from Supabase /rest/v1/contents
  - Looks for "r2_url:" embedded in description (because upload saved it there)
  - If found uses <video> tag to play it
*/

const SUPabase = {
  url: 'https://uewvmldolwgihfkxwlsl.supabase.co',
  anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVld3ZtbGRvbHdnaWhma3h3bHNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5MzQ1MjksImV4cCI6MjA3OTUxMDUyOX0.b9C00OjIkAUDPztC8RtdHcwjdgX4OrShNW_pp6r-_qI'
};

const params = new URLSearchParams(location.search);
const id = params.get('id');

if(!id){
  document.getElementById('title').innerText = 'Missing id param';
  document.getElementById('playerWrap').innerHTML = '<div class="small">Open this page with ?id=CONTENT_ID</div>';
} else {
  loadContent(decodeURIComponent(id));
}

async function loadContent(cid){
  try {
    const res = await fetch(SUPabase.url + '/rest/v1/contents?id=eq.' + cid + '&select=*', {
      headers: {
        apikey: SUPabase.anonKey,
        Authorization: 'Bearer ' + SUPabase.anonKey
      }
    });
    if(!res.ok) throw new Error('Supabase responded ' + res.status);
    const rows = await res.json();
    if(!rows || rows.length === 0) throw new Error('Content not found');
    const row = rows[0];
    render(row);
  } catch(err){
    console.error(err);
    document.getElementById('title').innerText = 'Failed to load content';
    document.getElementById('playerWrap').innerHTML = '<div class="small">' + err.message + '</div>';
  }
}

function extractR2Url(description){
  if(!description) return null;
  const m = description.match(/r2_url:\s*(https?:\/\/\S+)/i);
  return m ? m[1] : null;
}

function render(row){
  document.getElementById('title').innerText = row.title || '(Untitled)';
  const meta = document.getElementById('meta');
  meta.innerHTML = `<div class="small">${row.kind || ''} • ${row.published_at ? new Date(row.published_at).toLocaleString() : ''}</div><div style="margin-top:6px;color:#ccc">${row.description ? row.description.split('\\n').slice(0,2).join('<br>') : ''}</div>`;
  const r2 = extractR2Url(row.description);
  const playerWrap = document.getElementById('playerWrap');
  if(!r2){
    playerWrap.innerHTML = '<div class="small">No r2_url found in description. Cannot play.</div>';
    return;
  }
  // Create video element
  const vid = document.createElement('video');
  vid.controls = true;
  vid.src = r2;
  vid.crossOrigin = 'anonymous';
  playerWrap.innerHTML = '';
  playerWrap.appendChild(vid);
  // try to autoplay muted for preview
  vid.muted = true;
  vid.play().catch(()=>{ /* ignore autoplay block */ vid.muted = false;});
}
</script>
</body>
</html>
